@page "/admin/"

@using BookwormsUI.Components.Auth
@using BookwormsUI.Extensions
@inject RequestService requestService

<AuthGuard RolesAllowed="Administrator" />

<h3>Bookworms Admin</h3>

<div class="py-4">
    <h5>Pending book requests</h5>
</div>

@if (pendingRequests == null)
    {
        <div>
            <h5>No pending requests found</h5>
        </div>
    }
    else
    {
        <div>
            <table class="table table-responsive">
                <thead>
                    <tr>
                        <th>Borrower</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Status</th>
                        <th>Date Requested</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var request in pendingRequests)
                    {
                    <tr>
                        <td>@request.BorrowerEmail</td>
                        <td>@request.BookTitle</td>
                        <td>@request.BookAuthor</td>
                        <td>@request.Status</td>
                        <td>@request.DateRequested.ToUKStandardDate()</td>
                        <td>
                            <button class="btn btn-success" 
                                @onclick="@(() => ShowConfirm(request.Id))">Mark as Sent
                            </button>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    }

@code {
    private List<Request> pendingRequests;

    [CascadingParameter] 
    public IModalService Modal { get; set; }

    protected override async Task OnInitializedAsync()
    {
        pendingRequests = await requestService.GetRequestsByStatus(RequestStatus.Pending);
    }

    private async Task ShowConfirm(int requestId)
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(ConfirmModal.Message), "This will start the borrower's lending period");

        parameters.Add(nameof(ConfirmModal.ConfirmButtonText), "Yes, confirm");
        parameters.Add(nameof(ConfirmModal.CancelButtonText), "No, cancel");

        var confirmModal = Modal.Show<ConfirmModal>("Are you sure?", parameters);
        var result = await confirmModal.Result;

        if (!result.Cancelled)
        {
            Console.WriteLine("Modal returned confirmation - requestId " + requestId + " marked as sent");
        }
        else
        {
            Console.WriteLine("Modal was cancelled");
        }
    }
}
